name: Build and Push Docker Images on Tag

on:
  push:
    tags:       # 仅在提交 tag 时触发工作流
      - '*'     # 匹配所有 tag

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 查找所有 Dockerfiles
      - name: Find Dockerfiles
        id: find_dockerfiles
        run: |
          # 查找仓库中的所有 Dockerfile
          DOCKERFILES=$(find . -name 'Dockerfile' || true)
          echo "Found Dockerfiles:"
          echo "$DOCKERFILES"
          echo "::set-output name=dockerfiles::$DOCKERFILES"

      # 3. 构建和推送镜像（基于 Git tag）
      - name: Build and Push Docker Images
        if: steps.find_dockerfiles.outputs.dockerfiles != ''
        run: |
          for dockerfile in ${{ steps.find_dockerfiles.outputs.dockerfiles }}; do
            # 根据 Dockerfile 路径生成镜像名称
            IMAGE_NAME=$(basename $(dirname $dockerfile))
            TAG_NAME=${{ github.ref_name }}  # 从 Git tag 提取版本号
            echo "Building and pushing image for $dockerfile as $IMAGE_NAME:$TAG_NAME..."
            docker build -f $dockerfile -t ghcr.io/${{ github.actor }}/$IMAGE_NAME:$TAG_NAME .
            docker push ghcr.io/${{ github.actor }}/$IMAGE_NAME:$TAG_NAME
            docker tag ghcr.io/${{ github.actor }}/$IMAGE_NAME:$TAG_NAME ghcr.io/${{ github.actor }}/$IMAGE_NAME:latest
            docker push ghcr.io/${{ github.actor }}/$IMAGE_NAME:latest
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
