# Exomiser Dockerfile
FROM ubuntu:24.04

# 定义版本号变量
ARG EXOMISER_VERSION=14.1.0
ARG YQ_VERSION=4.47.1

# 确保基础镜像正常并安装 JRE 和必要的工具
RUN apt-get update && \
    apt-get install -y wget unzip bash curl && \
    rm -rf /var/lib/apt/lists/*

# 单独安装 JRE 以便更好地调试
RUN apt-get update && \
    apt-get install -y openjdk-21-jre-headless && \
    rm -rf /var/lib/apt/lists/*

# 安装yq
RUN wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 && \
    chmod +x /usr/local/bin/yq

# 下载并解压 Exomiser 到指定路径
RUN cd /tmp && \
    wget https://github.com/exomiser/Exomiser/releases/download/${EXOMISER_VERSION}/exomiser-cli-${EXOMISER_VERSION}-distribution.zip && \
    unzip exomiser-cli-${EXOMISER_VERSION}-distribution.zip && \
    rm exomiser-cli-${EXOMISER_VERSION}-distribution.zip && \
    mv exomiser-cli-${EXOMISER_VERSION} /exomiser-cli-${EXOMISER_VERSION}

# 设置执行权限
RUN chmod +x /exomiser-cli-${EXOMISER_VERSION}/exomiser-cli-${EXOMISER_VERSION}.jar

# 创建必要的目录
RUN mkdir -p /run_data /deploy

# 创建配置目录并准备默认配置
RUN mkdir -p /exomiser-cli-${EXOMISER_VERSION}/config

# 设置环境变量
ENV JAVA_OPTS="-Xmx4g"
ENV EXOMISER_VERSION=${EXOMISER_VERSION}

# 设置工作目录
WORKDIR /deploy

# 复制运行脚本（在构建时从部署目录复制）
COPY exomiser/run_exomiser.sh /deploy/
COPY exomiser/default.yaml /exomiser-cli-${EXOMISER_VERSION}/config/default.yaml

# 设置脚本执行权限
RUN chmod +x /deploy/run_exomiser.sh

# 设置入口点为运行脚本
ENTRYPOINT ["/deploy/run_exomiser.sh"]

# 默认显示帮助
CMD ["--help"]
